nextflow_pipeline {

    name "Test Workflow main.nf"
    script "main.nf"
    tag "salmon"
    tag "pipeline"

    test("SALMON (Skip Alignment & Pseudo-Alignment) (GSE110004)") {

        when {
            params {
                outdir         = "$outputDir"
                pseudo_aligner = "salmon"
                skip_alignment = true
                skip_pseudo_alignment = true
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                { assert snapshot(UTILS.removeNextflowVersion("$outputDir")).match("software_versions") },
                { assert snapshot(path("$outputDir/pipeline_info/samplesheet.valid.csv")).match("samplesheet") },
                { assert snapshot(path("$outputDir/bbsplit/RAP1_IAA_30M_REP1.stats.txt"),
                                path("$outputDir/bbsplit/RAP1_UNINDUCED_REP1.stats.txt"),
                                path("$outputDir/bbsplit/RAP1_UNINDUCED_REP2.stats.txt"),
                                path("$outputDir/bbsplit/WT_REP1.stats.txt")).match("bbsplit") },
                { assert new File("$outputDir/bbsplit/WT_REP2.stats.txt").exists() },
                { assert snapshot(path("$outputDir/multiqc/multiqc_data/multiqc_cutadapt.txt"),
                                path("$outputDir/multiqc/multiqc_data/multiqc_fastqc.txt")).match("multiqc") },
                { assert new File("$outputDir/multiqc/multiqc_data/multiqc_general_stats.txt").exists() },
                { assert !new File("$outputDir/salmon/").exists() },
                { assert new File("$outputDir/trimgalore/RAP1_IAA_30M_REP1_1.fastq.gz_trimming_report.txt").exists() },
                { assert new File("$outputDir/trimgalore/RAP1_IAA_30M_REP1_2.fastq.gz_trimming_report.txt").exists() },
                { assert new File("$outputDir/trimgalore/RAP1_UNINDUCED_REP1.fastq.gz_trimming_report.txt").exists() },
                { assert new File("$outputDir/trimgalore/RAP1_UNINDUCED_REP2.fastq.gz_trimming_report.txt").exists() },
                { assert new File("$outputDir/trimgalore/WT_REP1_1.fastq.gz_trimming_report.txt").exists() },
                { assert new File("$outputDir/trimgalore/WT_REP1_2.fastq.gz_trimming_report.txt").exists() },
                { assert new File("$outputDir/trimgalore/WT_REP2_1.fastq.gz_trimming_report.txt").exists() },
                { assert new File("$outputDir/trimgalore/WT_REP2_2.fastq.gz_trimming_report.txt").exists() }
            )
        }

    }

}
